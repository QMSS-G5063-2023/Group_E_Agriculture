---
title: "Agriculture - World View"
author: "Chiamaka Azodo"
date: "2023-04-24"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: no
  fig_width: 5
  fig_height: 5
  
---

#### Packages
```{r, include=FALSE}

library(dplyr)
library(tidyverse)
library(janitor)
library(ggplot2)
library(scales)
library(plotly)
library(DT)
library(highcharter)
library(igraph)
library(tidygraph)
library(ggraph)
library(visNetwork)

```


#### Data Upload
```{r, include=FALSE}

# Set working directory
setwd("/Users/chiamakaazodo/Documents/data_vis_2023/Group_E_Agriculture")

# Upload the U.S. world wide agricultural trade partners data set
trade_partners_raw <- read.csv('data/FAO_Data/FAO_data_US_agriculture_trade_quantity_2001-2021.csv')

# Clean up the column names of the data sets
trade_partners_raw <- clean_names(trade_partners_raw)

summary(trade_partners_raw)

```


### U.S. Agriculture Trade Section Description

This section/tab of the project website will focus on the agricultural trade relationships for different fruits and vegetables. Import and export quantity of the produce will be used to understand the established trade networks the United States has for each produce. 

This tab will include 5 visuals:


### Data Setup 

```{r Trade Partners Data Setup}

# Select only the columns of interest in the dataset

trade_partners <- trade_partners_raw %>% 
  select(reporter_countries,
         partner_countries,
         element,
         item,
         year,
         value)
```


### Line graph of U.S. import and export for specific produce over time

```{r}
# Aggregate the data
produce_trade <- trade_partners %>% 
  select(element,
         item,
         year,
         value) %>% 
filter(item == "Dates") %>% 
group_by(element, year) %>% 
  summarise(value = sum(value))

produce_trade <- spread(produce_trade, element, value)
produce_trade <- clean_names(produce_trade)

# Create graph 

h <- highchart() %>% 
  hc_xAxis(categories = produce_trade$year,
           title = list(text = "Year")) %>% 
  hc_yAxis(title = list(text = "Trade Quantity in Tonnes")) %>%  
  hc_add_series(name = "Export Quantity", 
                data = produce_trade$export_quantity,
                color = "#f99976") %>% 
  hc_add_series(name = "Import Quantity", 
                data = produce_trade$import_quantity,
                color = "#7ac9af")


# Add naming specfications to the graph
h <- h %>%
  hc_title(text = "U.S. Produce Trade Over Time",
           margin = 20, 
           align = "center",
           style = list(color = "black")) %>% 
  hc_subtitle(text = "Data from trade between 2001 - 2021",
              align = "center",
              style = list(color = "#black", 
                           fontWeight = "italic")) %>% 
  hc_credits(enabled = TRUE, # add credits
             text = "Source: Food and Agriculture Organization of the United Nations",
             style = list(color = "#black", 
                           fontWeight = "italic")) %>% 
  hc_legend(align = "right", 
            verticalAlign = "top",
            layout = "vertical", 
            x = 0, 
            y = 100) %>%
  hc_tooltip(crosshairs = TRUE, 
             backgroundColor = "#FCFFC5",
             shared = TRUE, 
             borderWidth = 4) 

h
  

# Dates have an interesting trade relationship

```





































### Import Quantity Network Analysis

```{r Data Setup}

# In this data set, the nodes are the reporter_countries and partner_countries columns and value column is the edge weight 
# Code instruction set up source: http://www.sthda.com/english/articles/33-social-network-analysis/135-network-visualization-essentials-in-r/

#### Create Nodes List

# Select the distinct reporter countries in this case its all U.S.
report_country <- import_trade_partners %>%
  distinct(reporter_countries) %>%
  rename(label = reporter_countries)

# Select the distinct partner countries
partner_country <- import_trade_partners %>%
  distinct(partner_countries) %>%
  rename(label = partner_countries)

# Join the two data sets to create node
nodes <- full_join(report_country, partner_country, by = "label") 

# Add unique ID for each country
nodes <- nodes %>%
  mutate(id = 1:nrow(nodes)) %>%
  select(id, everything())
head(nodes, 5)


#### Create Edges List

# Rename the value column to weight in the imports data set
import_trade_partners <- import_trade_partners %>%
  rename(weight = value)

# (a) Join nodes id for the report countries column and rename the id column to "to"
edges <- import_trade_partners %>% 
  left_join(nodes, by = c("reporter_countries" = "label")) %>% 
  rename(to = id)

# (b) Join nodes id for the partner countries column and rename the id column to "from"
edges <- edges %>% 
  left_join(nodes, by = c("partner_countries" = "label")) %>% 
  rename(from = id)

# (c) Select only the columns "from", "to", and "weight" columns
edges <- edges %>%
  select(from, to, weight)

head(edges, 5)


```

```{r Network visualization}
# Use tidy graph to create the dataset
net_tidy <- tbl_graph(
  nodes = nodes, edges = edges, directed = TRUE
  )


# Use the ggraph package to make a simple network visual
set.seed(20) #set seed so that the visual is replicable

ggraph(net_tidy, layout = "graphopt") + 
  geom_node_point() +
  geom_edge_link(aes(width = weight), alpha = 0.8) + 
  scale_edge_width(range = c(0.2, 2)) +
  geom_node_text(aes(label = label), repel = TRUE) +
  labs(edge_width = "import_trade_partners") +
  theme_graph()

```

#### Interactive Network Visualization

```{r Interactive Network visualization}

# Create a basic interactive network visualization using VisNetwork
visNetwork(nodes, edges, width="100%", height="400px")


# Improve upon the basic visual by adding specifications 
# Learn more about specific by running ?visNodes and ?visEdges

# Recreate the data frame into new names as the data frames will be adapted
vis_nodes <- nodes
vis_edges <- edges

# Add a row to edges so that it has the same number of rows as nodes, this will be helpful later for labeling 
#vis_edges[nrow(vis_edges) + 1,] <- list(1, 1, 20)

vis_nodes$shape  <- "dot"  
vis_nodes$shadow <- TRUE # Nodes will drop shadow
#vis_nodes$title  <- vis_edges$weight # Text on click
vis_nodes$label  <- vis_nodes$label # Node label
#vis_nodes$size   <- vis_edges$weight # Node size
vis_nodes$borderWidth <- 2 # Node border width

vis_nodes$color.background <- c("#f99976")
vis_nodes$color.border <- "black"
vis_nodes$color.highlight.background <- "#7ac9af"
vis_nodes$color.highlight.border <- "#7a8dbf"

visNetwork(vis_nodes, vis_edges)

```
















